<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zhita.dao.manage.CollectionMapper">
	
		<select id="OrderIdMa" resultType="java.lang.Integer" parameterType="java.lang.Integer">
			select c.orderId from collection c,collection_member com where 
			com.companyId=#{companyId} and com.collectionMemberId = c.collectionMemberId
			group by c.orderId
		</select> 
		
		
		<select id="SelectTotalCount" parameterType="com.zhita.model.manage.Collection" resultType="java.lang.Integer">
			select count(*) from orders where id not in
			<foreach collection="ids" item="nos" index="no" open="(" separator="," close=")">
		 		  #{nos}
		 	</foreach>
		 	AND companyId = #{companyId}
		</select>
		
		
		<select id="Allorderdetails" parameterType="com.zhita.model.manage.Collection" resultType="com.zhita.model.manage.Orderdetails">
			select ord.orderId,o.orderNumber,u.name,u.phone,o.borrowMoneyWay,o.borrowTimeLimit,o.shouldReturnTime,ord.overdueNumberOfDays,ord.interestPenaltySum,
			o.orderCreateTime,ord.realityBorrowMoney,ord.makeLoans,ord.realityAccount
			 from orders o LEFT JOIN orderdetails ord on o.id = ord.orderId
			 	LEFT JOIN user u on u.id = o.userId
			<where>
				AND ord.orderId not in
				<foreach collection="ids" item="nos" index="no" open="(" separator="," close=")">
		 		 	 #{nos}
		 		</foreach>
			    AND o.orderStatus = "1"
				AND o.companyId = #{companyId}
				<if test="name != '' and name != null">
					AND u.name like CONCAT('%',#{name},'%') 
				</if>
				<if test="phone != null and phone != ''">
					AND u.phone like CONCAT('%',#{phone},'%') 
				</if>
				<if test="id != null and id != ''">
					AND o.id = #{id}
				</if>
			</where>
			group by ord.orderId 
			limit #{page},#{pagesize}
		</select>
		
		
		
		<select id="DefeSet" parameterType="com.zhita.model.manage.Orderdetails" resultType="com.zhita.model.manage.Deferred">
			select MAX(defe.id),defe.deferBeforeReturntime,defe.interestOnArrears,deset.onceDeferredDay,defe.deferAfterReturntime from 
			deferred defe,deferred_settings deset,orders o where o.companyId = deset.companyId and o.id = defe.orderid
			and o.id = #{orderId}
		</select>
		
		
		<select id="CollMen" parameterType="com.zhita.model.manage.Orderdetails" resultType="com.zhita.model.manage.Collection">
			select colme.reallyName,col.collectionTime,col.collectionStatus from collection col,collection_member colme,orders o
			where o.id = col.orderId and col.collectionMemberId = colme.collectionMemberId and o.id =#{orderId}
		</select>
		
		
		<select id="CollectionAll" parameterType="java.lang.Integer" resultType="com.zhita.model.manage.Collection_member">
			select * from collection_member where companyId = #{companyId}
		</select>
		
		
		
		<insert id="addCollection" parameterType="java.util.List">
			insert into `collection` (collectionMemberId,orderId,collectionStatus,collectionTime,deleted) values  
	        <foreach collection="list" item="item" index="index" separator=",">  
	            (#{item.collectionMemberId},#{item.orderId},#{item.collectionStatus},#{item.collectionTime},#{item.deleted})  
	        </foreach>
		</insert>
		
		
		
		<select id="SelectOrdersdetails" parameterType="com.zhita.model.manage.Orderdetails" resultType="com.zhita.model.manage.Orderdetails">
			select ord.orderId,o.orderNumber,u.name,u.phone,o.borrowMoneyWay,o.borrowTimeLimit,o.shouldReturnTime,ord.overdueNumberOfDays,ord.interestPenaltySum,
			o.orderCreateTime,ord.realityBorrowMoney,ord.makeLoans,ord.realityAccount,colme.reallyName,o.overdueGrade,ord.surplus_money,
			col.collectionTime,col.collectionStatus,o.orderStatus,o.overdueGrade
			from orders o,orderdetails ord,collection col,user u,collection_member colme
			<where>
				    o.id = ord.orderId 
				and col.orderId = o.id
				and o.companyId = #{companyId}
				and u.id = o.userId 
				and colme.collectionMemberId = col.collectionMemberId
				<if test="realityBorrowMoney != null and realityBorrowMoney != ''">
					AND ord.realityBorrowMoney = #{realityBorrowMoney}
				</if>
				<if test="overdueGrade != null and overdueGrade != ''">
					AND o.overdueGrade = #{overdueGrade}
				</if>
				<if test="makeLoans != null and makeLoans != ''">
					AND ord.makeLoans = #{makeLoans}
				</if>
				<if test="shouldAlsoInterest != null and shouldAlsoInterest != ''">
					AND ord.shouldAlsoInterest = #{shouldAlsoInterest}
				</if>
				<if test="shouldReapyMoney != null and shouldReapyMoney != ''">
					AND ord.shouldReapyMoney = #{shouldReapyMoney}
				</if>
				<if test="orderId != null and orderId != ''">
					AND o.id = #{orderId}
				</if>
				<if test="name != '' and name != null">
					AND u.name LIKE concat('%',#{name},'%')
				</if>
				<if test="phone != null and phone != ''">
					AND u.phone LIKE concat('%',#{phone},'%')
				</if>
				<if test="grade != null and grade != ''">
					AND o.grade = #{grade}
				</if>
				<if test="collectionStatus != null and collectionStatus != ''">
					AND col.collectionStatus = #{collectionStatus}
				</if>
				<if test="collectionMemberId != null and collectionMemberId != ''">
					AND col.collectionMemberId = #{collectionMemberId}
				</if>
				<if test="start_time != null and start_time != '' and end_time != null and end_time != ''">
					AND col.collectionTime between #{start_time} and #{end_time}
				</if>
				<if test="deferBeforeReturntime != null and deferBeforeReturntime != '' and deferAfterReturntime != null and deferAfterReturntime != ''">
					AND col.collectionTime between #{start_time} and #{end_time}
				</if>
			</where>
			group by o.id
			limit #{page},#{pagesize}
		</select>
		
		
		
		<select id="OneOrdersdetails" parameterType="com.zhita.model.manage.Orderdetails" resultType="com.zhita.model.manage.Orderdetails">
			select o.borrowTimeLimit,orders.*,u.name,u.phone,c.collectionStatus,cmem.reallyName,overdue.grade,
			c.collectionTime,o.orderNumber,o.id,o.borrowMoneyWay,defe.deferBeforeReturntime,defe.deferAfterReturntime 
			from 
			collection c left join collection_member cmem on c.collectionMemberId = cmem.collectionMemberId
			left join orders o on o.id = c.orderId
			left join overdue_class overdue on o.companyId = overdue.companyId
			left join user u on u.id = o.userId
			left join orderdetails orders on o.id =orders.orderId
			left join deferred defe on defe.orderId
			<where>
				AND o.orderNumber LIKE concat('%',#{orderNumber},'%') 
				AND o.companyId = #{companyId}
			</where>	
				group by orders.orderId
				limit #{page},#{pagesize}	
		</select>
		
		
		
		<select id="SelectSumOrderNum" resultType="com.zhita.model.manage.Collection" parameterType="com.zhita.model.manage.Collection">
			select  o.orderCreateTime  from orders o
				<where>
					AND o.companyId = #{companyId} 
					<if test="borrowMoneyType != null and borrowMoneyType != ''">
						AND o.borrowMoneyType = #{borrowMoneyType}
					</if>
					<if test="start_time != null and start_time != '' and end_time != null and end_time != ''">
						AND o.orderCreateTime between #{start_time} and #{end_time}
					</if>
				</where>
				GROUP BY o.orderCreateTime
		</select>
	
 	
		<select id="SelectSumOrder" resultType="com.zhita.model.manage.Collection" parameterType="com.zhita.model.manage.Collection">
			select col.collectionTime,count(col.orderId) as collection_count from orders o,collection col
				<where>
					and o.id = col.orderId
					AND o.companyId = #{companyId} 
					<if test="borrowMoneyType != null and borrowMoneyType != ''">
						AND o.borrowMoneyType = #{borrowMoneyType}
					</if>
					<if test="start_time != null and start_time != '' and end_time != null and end_time != ''">
						AND o.orderCreateTime between #{start_time} and #{end_time}
					</if>
				</where>
				GROUP BY col.collectionTime
				limit #{page},#{pagesize}
		</select>
		
		
		
		
		<select id="SelectReallyName" parameterType="com.zhita.model.manage.Collection" resultType="com.zhita.model.manage.Collection">
			select colme.reallyName,c.collectionTime,count(c.collectionTime) as collection_count from 
			collection c,collection_member colme
			<where>
				AND c.collectionMemberId = colme.collectionMemberId 
				<if test="start_time != null and statu_time != '' and end_time != null and end_time != ''">
					AND collectionTime between #{statu_time} and#{end_time}
				</if>
			</where>
			GROUP BY c.collectionMemberId
			limit #{page},#{pagesize}
		</select>
		
		
		
		<select id="OrderOknum" parameterType="java.lang.String" resultType="java.lang.Integer">
			select count(*) from collection where collectionTime = #{collectionTime}
		</select>
		
		
		<select id="OrderChengnuo" parameterType="com.zhita.model.manage.Collection" resultType="java.lang.Integer">
			select count(*) from collection where collectionTime = #{collectionTime} and collectionStatus = #{collectionStatus}
		</select>
		
		
		
		<select id="SelectUserNum" resultType="com.zhita.model.manage.Collection" parameterType="com.zhita.model.manage.Collection">
			SELECT collectionTime from collection
				<where>
					<if test="collectionMemberId != null and collectionMemberId != ''">
						AND collectionMemberId = #{collectionMemberId}
					</if>
					<if test="start_time != null and start_time != '' and end_time != null and end_time != ''">
						AND collectionTime between #{start_time} and #{end_time}
					</if>
				</where>
		</select>
		
		
		<select id="Collectionmemberdetilas" resultType="com.zhita.model.manage.Collection" parameterType="com.zhita.model.manage.Collection">
			SELECT cmember.reallyName,count(c.collectionId) as collection_count,c.collectionTime,c.collectionMemberId
			from collection c,collection_member cmember
		 	<where>
		 		AND c.collectionMemberId=cmember.collectionMemberId
				<if test="collectionMemberId != null and collectionMemberId != ''">
					AND c.collectionMemberId = #{collectionMemberId}
				</if>
				<if test="start_time != null and start_time != '' and end_time != null and end_time != ''">
					AND c.collectionTime between #{start_time} and #{end_time}
				</if>
			</where>
		 	GROUP BY c.collectionMemberId
		 	limit #{page},#{pagesize}
		</select>
		
		
		<select id="CollectionNum" parameterType="com.zhita.model.manage.Collection" resultType="java.lang.Integer">
			select count(*) from collection where collectionMemberId = #{collectionMemberId} and collectionStatus = #{collectionStatus}
		</select>
		
		
		<select id="FenpeiCollection" parameterType="com.zhita.model.manage.Collection" resultType="com.zhita.model.manage.Orderdetails">
			select col.collectionId,ord.orderId,o.orderNumber,u.name,u.phone,o.borrowMoneyWay,o.borrowTimeLimit,o.shouldReturnTime,ord.overdueNumberOfDays,ord.interestPenaltySum,
			o.orderCreateTime,ord.realityBorrowMoney,ord.makeLoans,ord.realityAccount,colme.reallyName,o.overdueGrade,ord.surplus_money,col.collectionTime,
			col.promise_money,col.collectionTime,col.collectionStatus,o.orderStatus
			from collection col,orders o,orderdetails ord,collection_member colme,user u 
			<where>
				o.id = col.orderId 
				and o.id = ord.orderId 
				and col.collectionMemberId = colme.collectionMemberId 
				and u.id = o.userId 
				AND orderStatus = "1"
				<if test="name != null and name != ''">
					AND u.name LIKE concat('%',#{name},'%')  
				</if>
				<if test="phone != null and phone != ''">
					AND u.phone LIKE concat('%',#{phone},'%')   
				</if>
				<if test="orderNumber != null and orderNumber != ''">
					AND o.orderNumber LIKE concat('%',#{orderNumber},'%')    
				</if>
				AND col.collectionMemberId = #{collectionMemberId}
				AND o.companyId = #{companyId} 
				AND col.collectionStatus is null
			</where>
				group by col.orderId
				limit #{page},#{pagesize}
		</select>
		
		
		<select id="CollectionTotalcount" parameterType="com.zhita.model.manage.Collection" resultType="java.lang.Integer">
			select count(c.orderId) from 
			collection c left join collection_member cmem on c.collectionMemberId = cmem.collectionMemberId
			left join orderdetails orders on c.orderId = orders.orderId
			left join orders o on o.id = c.orderId
			left join overdue_class overdue on o.companyId = overdue.companyId
			left join user u on u.id = o.userId
			<where>
				<if test="name != null and name != ''">
					AND u.name LIKE concat('%',#{name},'%')    
				</if>
				<if test="phone != null and phone != ''">
					AND u.phone LIKE concat('%',#{phone},'%')
				</if>
				<if test="orderNumber != null and orderNumber != ''">
					AND o.orderNumber LIKE concat('%',#{orderNumber},'%') 
				</if>
				AND o.companyId = #{companyId} 
				AND c.orderId not in 
				<foreach collection="ids" item="orderid" open="(" separator="," close=")">
					#{orderid}
				</foreach>
			</where>
			group by c.orderId
		</select>
		
		
		<select id="AllCountNum" parameterType="com.zhita.model.manage.Collection" resultType="java.lang.Integer">
			SELECT COUNT(c.collectionId) from collection c,collection_member com where c.collectionMemberId = com.collectionMemberId 
			and com.companyId = #{companyId} and c.collectionMemberId = #{collectionMemberId}
		</select>
		
		
		<select id="CollectionWeiTotalcount" parameterType="com.zhita.model.manage.Collection" resultType="java.lang.Integer">
			select count(o.id) from collection 
			c,collection_member cmem,orderdetails orders,orders o,user u,deferred defe
			<where>
				AND o.id = orders.orderId
				AND u.id = o.userId
				AND o.id = defe.orderId
				AND c.orderId = o.id
				AND c.collectionMemberId = cmem.collectionMemberId
				AND o.companyId = #{companyId} 
				<if test="name != null and name != ''">
					AND u.name LIKE concat('%',#{name},'%')  
				</if>
				<if test="phone != null and phone != ''">
					AND u.phone LIKE concat('%',#{phone},'%')  
				</if>
				<if test="orderNumber != null and orderNumber != ''">
					AND o.orderNumber LIKE concat('%',#{orderNumber},'%') 
				</if>
				<if test="deferAfterReturntimeStatu_time != null and deferAfterReturntimeStatu_time != '' and deferAfterReturntimeEnd_time != null and deferAfterReturntimeEnd_time != ''">
					AND defe.deferAfterReturntime between #{deferAfterReturntimeStatu_time} and #{deferAfterReturntimeEnd_time}
				</if>
				AND o.id  in 
				<foreach collection="ids" item="orderid" open="(" separator="," close=")">
					#{orderid}
				</foreach>
			</where>
		</select>
		
		
		
		<select id="SelectCollectionId" parameterType="java.lang.Integer" resultType="java.lang.Integer">
			select collectionMemberId from collection_member where companyId = #{companyId}
		</select>
		
		
		<select id="SelectCollectionMemberIds" parameterType="java.util.List" resultType="java.lang.Integer">
			select orderId from collection where collectionMemberId in 
			<foreach collection="ids" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
			group by orderId
		</select>
		
		
		<select id="SelectId" parameterType="java.lang.Integer" resultType="java.lang.Integer">
			select c.orderId from collection c,collection_member coml where coml.companyId = #{id} and collectionStatus is not null
			group by orderId
		</select>
		
		<select id="OneCollection" parameterType="com.zhita.model.manage.Orderdetails" resultType="com.zhita.model.manage.Collectiondetails">
			select col.collection_time,col.user_type,col.collectionmoney,col.orderId,col.collectionMemberId,o.orderStatus from collectiondetails col,orders o
			<where>
				orderId = #{orderId} 
				AND o.id = col.orderId
			</where>
		</select>
				
				
		<select id="WeiControllerOrdetialis" parameterType="com.zhita.model.manage.Orderdetails" resultType="com.zhita.model.manage.Orderdetails">
			select o.id,ord.orderId,o.orderNumber,u.name,u.phone,o.borrowMoneyWay,o.borrowTimeLimit,o.shouldReturnTime,ord.overdueNumberOfDays,ord.interestPenaltySum,
			o.orderCreateTime,ord.realityBorrowMoney,ord.makeLoans,ord.realityAccount,colme.reallyName,o.overdueGrade,ord.surplus_money,col.collectionTime,
			col.promise_money,col.promise_money,col.collectionTime,col.collectionStatus,o.orderStatus,defe.deferBeforeReturntime,defe.deferAfterReturntime,o.overdueGrade 
			 from orders o ,orderdetails ord,collection_member colme,user u ,deferred defe,deferred_settings deset,overdue_class ov,collection col
			<where>
				o.companyId = ov.companyId 
				and  o.id = ord.orderId  
				and deset.companyId = o.companyId 
				and o.id = defe.orderId 
				and u.id = o.userId 
				and o.id = col.orderId 
				and col.collectionMemberId = colme.collectionMemberId
				and col.deleted = "0"
				and col.usertype is not null
				<if test="name != null and name != ''">
					AND u.name LIKE concat('%',#{name},'%')  
				</if>
				<if test="phone != null and phone != ''">
					AND u.phone LIKE concat('%',#{phone},'%') 
				</if>
				<if test="orderNumber != null and orderNumber != ''">
					AND o.orderNumber LIKE concat('%',#{orderNumber},'%')  
				</if>
				<if test="overdueGrade != null and overdueGrade != ''">
					AND o.overdueGrade = #{overdueGrade}
				</if>
				<if test="start_time != null and start_time != '' and end_time != null and end_time != ''">
					AND o.orderCreateTime between #{start_time} and #{end_time}
				</if>
				<if test="realtime != null and realtime != ''">
					AND ord.realtime = #{realtime}
				</if>
				<if test="describe != null and describe != ''">
					AND ord.overdueNumberOfDays = #{describe}
				</if>
				<if test="deferAfterReturntimeStatu_time != null and deferAfterReturntimeStatu_time != '' and deferAfterReturntimeEnd_time != null and deferAfterReturntimeEnd_time != ''">
					AND defe.deferAfterReturntime between #{deferAfterReturntimeStatu_time} and #{deferAfterReturntimeEnd_time}
				</if>
				AND o.companyId = #{companyId} 
				AND o.orderStatus = "1"
			</where>
			group by o.id
			limit #{page},#{pagesize}
		</select>
		
		
		
		<select id="CollNum" parameterType="java.lang.Integer" resultType="java.lang.Integer">
			select count(collectionId) from collection where orderId = #{orderId}
		</select>
		
		
		<insert id="AddCollectionAs" parameterType="com.zhita.model.manage.Collection">
			INSERT INTO `Collection` (
				collectionMemberId,
				orderId,
				collectionStatus,
				collectionTime,
				deleted,
				promise_money
			)VALUES
			(#{collectionMemberId},#{orderId},#{collectionStatus},#{collectionTime},#{deleted},#{promise_money})
		</insert>
		
		
		<select id="SelectOrderNum" parameterType="com.zhita.model.manage.Collectiondetails" resultType="java.lang.Integer">
			select count(*) from orders where orderCreateTime = #{collection_time} and companyId = #{companyId}
		</select>
		
		
		
		<select id="SelectCollectionNum" parameterType="com.zhita.model.manage.Collectiondetails" resultType="java.lang.Integer">
			select count(*) from collection where collectionMemberId in
			<foreach collection="ids" item="id" open="(" separator="," close=")">
				#{id}
			</foreach>
			AND collectionTime = #{collectionTime}
		</select>
		
		
		<select id="SelectcollectionStatus" parameterType="com.zhita.model.manage.Collectiondetails" resultType="java.lang.Integer">
			select count(*) from collection where collectionMemberId in
			<foreach collection="ids" item="id" open="(" separator="," close=")">
				#{id}
			</foreach>
			AND collectionTime = #{collectionTime}
			AND collectionStatus = #{collectionStatus}
		</select>
		
		
			<select id="SelectUserCollectionNum" parameterType="com.zhita.model.manage.Collectiondetails" resultType="java.lang.Integer">
			select count(orderId) from collection where collectionMemberId = #{collectionMemberId}
			AND collectionTime = #{collectionTime} group by orderId
		</select>
		
		
		<select id="SelectUsercollectionStatus" parameterType="com.zhita.model.manage.Collectiondetails" resultType="java.lang.Integer">
			select count(*) from collection where  collectionMemberId = #{collectionMemberId}
			AND collectionTime = #{collectionTime}
			AND collectionStatus = #{collectionStatus}
		</select>
		
		
		
		
		<select id="DefNum" parameterType="java.lang.Integer" resultType="com.zhita.model.manage.Deferred">
			select count(id) as id,sum(interestOnArrears) as interestOnArrears from deferred where orderId = #{orderId}
		</select>
		
		
		<update id="UpdateCollectionDelete" parameterType="java.lang.Integer">
			update collection set deleted = "1" where orderId = #{orderId}			
		</update>
		
		
		<update id="UpdateOrderStatus" parameterType="java.lang.Integer">
			update orders set orderStatus = "4" where id = #{orderId}
		</update>
		
		
		<update id="UpdateCollection" parameterType="com.zhita.model.manage.Collection">
			update collection set usertype = #{usertype},promise_money = #{promise_money}, collectionStatus = #{collectionStatus} where collectionId = #{collectionId}
		</update>
		
		
		<insert id="AddCollOrders" parameterType="com.zhita.model.manage.Collectiondetails">
			INSERT INTO `collectiondetails`(
			collection_time,
			user_type,
			collectionmoney,
			collectionMemberId,
			orderId
			)
			VALUES
			(#{collection_time},#{user_type},#{collectionmoney},#{collectionMemberId},#{orderId})
		</insert>
		
</mapper>